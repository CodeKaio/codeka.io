[tools]
hugo-extended = "0.155"
node = "latest"
"npm:clever-tools" = "latest"

[env]
HUGO_OPTIONS = "--printI18nWarnings --printPathWarnings --cleanDestinationDir --logLevel debug --disableFastRender"

[tasks]

[tasks.fetch-views-data]
description = 'Fetch data from plausible'
dir = "scripts"
tools.go = "1.21"
run = "go run plausible_fetch.go -site codeka.io -range all -out ../data/plausible-stats/visits.json"

[tasks.fetch-bluesky-stats]
description = 'Fetch data from bluesky'
dir = "scripts"
tools.go = "1.21"
run = "go run bluesky_stats.go"

[tasks.build]
description = "Build le site avec Hugo"
run = "hugo build hugo --gc --minify --cleanDestinationDir --destination public"
depends_post = ["post-build"]

[tasks.post-build]
description = "Post build hooks"
depends_post = ["precompress"]

[tasks.precompress]
description = "Precompress static resources"
run = '''
COMPRESSREGEX=".*(html|css|js|xml|ico|svg|md|pdf|woff2)$"
find public/ -type f -regextype egrep -regex $COMPRESSREGEX | xargs zstd --keep --force -19
find public/ -type f -regextype egrep -regex $COMPRESSREGEX | xargs gzip --keep  --force --best
'''

[tasks.serve]
description = "Lance le serveur de développement Hugo"
depends = ['fetch-views-data']
run = "hugo server --openBrowser $HUGO_OPTIONS"

[tasks.draft]
description = "Serve Hugo en incluant les brouillons et futures publications"
depends = ['fetch-views-data']
run = "hugo server --openBrowser $HUGO_OPTIONS --buildDrafts --buildFuture"

[tasks.nbsp]
description = "Insère des espaces insécables avant ;?:! dans les posts"
run = '''
    sed -i '/^---$/,/^---$/b;s/ \([;?:!]\)/\ \1/g' content/posts/**/*.md
'''

[tasks."new-tech-watch-post"]
description = "Crée un nouveau post de veille"
usage = '''
arg "<date>" help="Date de publication du post"
'''
run = "hugo new content posts/${usage_date}-mi-veille -k veille"

[tasks."clever:preview"]
description = "Déploie une preview Clever Cloud et ouvre l'URL"
depends = ['fetch-views-data']
run = "clever deploy --alias preview --force && clever open --alias preview"

[tasks."clever:deploy"]
description = "Déploie sur l'alias Clever Cloud de production"
run = '''
clever link $PROD_APP_ID --alias codeka.io || true
clever deploy --alias codeka.io
'''
